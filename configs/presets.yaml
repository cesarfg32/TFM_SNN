# =====================
# PRESETS TFM — SNN/CL
# =====================
# ---- Bloque base (anclas) ----
defaults: &defaults
  model: &defaults_model
    name: pilotnet_snn
    img_w: 200
    img_h: 66
    to_gray: true

  data: &defaults_data
    # Codificación
    encoder: rate              # rate | latency | raw | image
    T: 10
    gain: 0.5
    use_offline_spikes: true
    encode_runtime: false

    # Reproductibilidad / rendimiento (estable /dev/shm)
    seed: 42
    num_workers: 6
    prefetch_factor: 2
    pin_memory: true
    persistent_workers: true
    pin_memory_device: "cuda"

    # Aumentos (ligeros por defecto)
    aug_train: &aug_light
      prob_hflip: 0.5
      brightness: [0.9, 1.1]
      contrast:   [0.9, 1.1]
      saturation: [0.9, 1.1]
      hue:        [-0.03, 0.03]
      gamma: null
      noise_std: 0.0

    # Balanceo online (desactivado por defecto)
    balance_online: false
    balance_bins: 50
    balance_smooth_eps: 0.001

  # División/prepare (offline)
  prep: &defaults_prep
    runs: ["circuito1", "circuito2"]
    merge_subruns: true
    use_left_right: true
    steer_shift: 0.2
    bins: 50
    train: 0.70
    val: 0.15
    seed: 42
    # Balanceo offline de imágenes
    balance_offline:
      mode: images          # images | none
      target_per_bin: auto
      cap_per_bin: 12000
      aug:
        prob_hflip: 0.0     # desactivar flips en offline
        brightness: [0.8, 1.2]
        contrast:   [0.8, 1.2]
        saturation: [0.8, 1.2]
        hue:        [-0.1, 0.1]
        gamma: null
        noise_std: 0.0
    tasks_file_name: tasks.json
    tasks_balanced_file_name: tasks_balanced.json
    use_balanced_tasks: true
    encode_h5: false

  optim: &defaults_optim
    amp: true
    lr: 0.001
    epochs: 2
    es_patience: null
    es_min_delta: null
    batch_size: 160

  # EWC por defecto salvo que se sobrescriba
  continual: &defaults_continual
    method: ewc
    params:
      lambd: 1.0e9
      fisher_batches: 1000

  # Control de logs
  logging: &defaults_logging
    telemetry:
      codecarbon: true
      offline: true
      country_iso_code: "ESP"
      measure_power_secs: 15
      log_level: "error"

    ewc:
      fisher_verbose: false
      verbose: false
      every: 256   # si verbose activo
    rehearsal:
      buffer_verbose: false
      replay_verbose: false
      replay_show_shapes: false
    as-snn:
      verbose: false
      every: 256
    sa-snn:
      verbose: false
      every: 256
    sca-snn:
      verbose: false
      every: 256

  naming: &defaults_naming
    tag: ""

# ---- Presets ----
fast:
  <<: *defaults
  data:
    <<: *defaults_data
    T: 12
    gain: 0.90
  optim:
    <<: *defaults_optim
    lr: 6.0e-4
    epochs: 2
    batch_size: 320
    es_patience: null
    es_min_delta: null
    compile: false
  continual:
    <<: *defaults_continual
  prep:
    <<: *defaults_prep
  logging:
    <<: *defaults_logging
    telemetry:
      codecarbon: true
      offline: true
      country_iso_code: "ESP"
      measure_power_secs: 15
      log_level: "error"

    ewc:
      fisher_verbose: true
      verbose: true
      every: 256   # si activas verbose, imprimirá cada 256 iters
    rehearsal:
      buffer_verbose: true
      replay_verbose: true
      replay_show_shapes: false
    as-snn:
      verbose: true
      every: 256
    sa-snn:
      verbose: true
      every: 256
    sca-snn:
      verbose: true
      every: 256
  naming:
    <<: *defaults_naming

std:
  <<: *defaults
  data:
    <<: *defaults_data
    T: 18
    gain: 0.70
  optim:
    <<: *defaults_optim
    lr: 5.0e-4
    epochs: 16
    batch_size: 256
    es_patience: null
    es_min_delta: null
  continual:
    <<: *defaults_continual
  prep:
    <<: *defaults_prep
  logging:
    <<: *defaults_logging
    telemetry:
      codecarbon: true
      offline: true
      country_iso_code: "ESP"
      measure_power_secs: 15
      log_level: "error"

    # Puedes usar estas dos claves universales por método (gracias al alias):
    ewc:
      fisher_verbose: true
      verbose: true
      every: 256   # si activas verbose, imprimirá cada 256 iters
    rehearsal:
      buffer_verbose: true
      replay_verbose: true
      replay_show_shapes: false
    as-snn:
      verbose: true
      every: 256
    sa-snn:
      verbose: true
      every: 256
    sca-snn:
      verbose: true
      every: 256
  naming:
    <<: *defaults_naming

# Nuevo preset para la siguiente fase (no se ejecuta ahora)
std_t16:
  <<: *defaults
  data:
    <<: *defaults_data
    T: 16          # recomendado
    gain: 0.50     # recomendado
  optim:
    <<: *defaults_optim
    lr: 5.0e-4
    epochs: 8
    batch_size: 240   # mantiene aprox B·T ≈ 3840
    es_patience: 2
    es_min_delta: 7.5e-4
    compile: false
  continual:
    <<: *defaults_continual
  prep:
    <<: *defaults_prep
  logging:
    <<: *defaults_logging
  naming:
    <<: *defaults_naming


accurate:
  <<: *defaults
  data:
    <<: *defaults_data
    T: 30
    gain: 0.5
  optim:
    <<: *defaults_optim
    lr: 7.5e-4
    epochs: 20
    batch_size: 160
    es_patience: null
    es_min_delta: null
    compile: false
  continual:
    <<: *defaults_continual
  prep:
    <<: *defaults_prep
  logging:
    <<: *defaults_logging
  naming:
    <<: *defaults_naming
